<main class="register">
    <div class="register__container">
        @if (currentRegistrationPhase() === 1) {
        <div class="form-container">
            <a [routerLink]="['/']" class="hyperlink homePageLink"
                ><mat-icon svgIcon="arrowLeft"></mat-icon
                ><span> {{ "register.goHomeLink" | translate }}</span></a
            >

            <form [formGroup]="personalInfoForm()" (ngSubmit)="goToNextStep()">
                <h2>{{ "register.title" | translate }}</h2>
                <div class="forms">
                    <div class="fullName">
                        <app-label-input
                            controlName="firstName"
                            [label]="'register.firstName.label' | translate"
                            [errors]="VALIDATION_KEYS.firstName"
                        ></app-label-input>

                        <app-label-input
                            controlName="lastName"
                            [label]="'register.lastName.label' | translate"
                            [errors]="VALIDATION_KEYS.lastName"
                        ></app-label-input>

                        <app-label-input
                            controlName="middleName"
                            [label]="'register.middleName.label' | translate"
                            [errors]="VALIDATION_KEYS.middleName"
                        ></app-label-input>
                    </div>
                    <div class="email">
                        <app-label-input
                            controlName="email"
                            [label]="'register.email.label' | translate"
                            [errors]="VALIDATION_KEYS.email"
                            type="email"
                            [isEmail]="true"
                            domainSuffix="@knu.ua"
                            (emailInput)="onEmailInput($event)"
                            (emailBlur)="formatEmailOnBlur()"
                        ></app-label-input>

                        <div class="email-create">
                            <p>{{ "register.KNUEmail.label" | translate }}</p>
                            <a
                                href="https://student.triton.knu.ua/CorporativeMail"
                                class="hyperlink"
                                >{{ "register.KNUEmail.link" | translate }}</a
                            >
                        </div>
                    </div>
                    <div class="password">
                        <app-label-input
                            controlName="password"
                            [label]="'register.password.label' | translate"
                            [errors]="VALIDATION_KEYS.password"
                            type="password"
                            [preventClipboard]="true"
                        ></app-label-input>

                        <app-label-input
                            controlName="confirmPassword"
                            [label]="
                                'register.confirmPassword.label' | translate
                            "
                            [errors]="VALIDATION_KEYS.confirmPassword"
                            type="password"
                            [preventClipboard]="true"
                        ></app-label-input>
                    </div>
                </div>
                <button type="submit" class="fill-button fill-red">
                    {{ "register.continue" | translate }}
                </button>

                <div class="login">
                    <p>{{ "register.haveAccount.label" | translate }}</p>
                    <a [routerLink]="['/auth/login']" class="hyperlink">{{
                        "register.haveAccount.link" | translate
                    }}</a>
                </div>
            </form>
        </div>
        } @if (currentRegistrationPhase() === 2) {
        <form
            [formGroup]="academicInfoForm()"
            (ngSubmit)="onSubmit()"
            class="formSecond"
        >
            <h2>{{ "register.title" | translate }}</h2>
            <div class="inputs">
                <div class="firstRow">
                    <div class="form-group">
                        <register-write-dropdowns
                            [class.drop-down__error]="departmentLoadError()"
                            [options]="departments"
                            [placeholder]="
                                'register.departments.label' | translate
                            "
                            valueField="id"
                            formControlName="departmentId"
                            (selectionChange)="onDepartmentChange()"
                            [hasError]="departmentLoadError()"
                            [errorMessage]="
                                'errors.departmentLoadError' | translate
                            "
                        ></register-write-dropdowns>
                        @if ( showValidationErrors() &&
                        academicInfoForm().get("departmentId")?.errors?.[
                        "required" ] ) {
                        <div class="error">
                            <mat-icon svgIcon="errorQuadrilateral"></mat-icon
                            >You must select a department
                        </div>
                        } @if (backendErrors()["departmentId"]) { @for ( error
                        of backendErrors()["departmentId"]; track $index ) {
                        <div class="error">
                            <mat-icon svgIcon="errorQuadrilateral"></mat-icon
                            >{{ error }}
                        </div>
                        } }
                    </div>

                    <div class="form-group">
                        @if (!academicInfoForm().get("departmentId")?.value) {
                        <register-write-dropdowns
                            [options]="(specialties$ | async) || []"
                            [placeholder]="
                                'register.specialties.label' | translate
                            "
                            valueField="codeName"
                            formControlName="specialtyCodename"
                            class="disabled"
                        ></register-write-dropdowns>

                        <p class="warning">
                            <mat-icon svgIcon="errorTriangle"></mat-icon>
                            <span
                                >{{
                                    "register.mustSelectDepartment" | translate
                                }}
                            </span>
                        </p>
                        } @else {
                        <register-write-dropdowns
                            [class.drop-down__error]="specialtyLoadError()"
                            [options]="(specialties$ | async) || []"
                            [placeholder]="
                                'register.specialties.label' | translate
                            "
                            valueField="codeName"
                            formControlName="specialtyCodename"
                            [hasError]="specialtyLoadError()"
                            [errorMessage]="
                                'errors.specialtyLoadError' | translate
                            "
                        ></register-write-dropdowns>
                        @if ( showValidationErrors() &&
                        academicInfoForm().get("specialtyCodename")?.errors?.[
                        "required" ] ) {
                        <div class="error">
                            <mat-icon svgIcon="errorQuadrilateral"></mat-icon
                            >You must select a specialty
                        </div>
                        } @if (backendErrors()["specialtyCodename"]) { @for (
                        error of backendErrors()["specialtyCodename"]; track
                        $index ) {
                        <div class="error">
                            <mat-icon svgIcon="errorQuadrilateral"></mat-icon
                            >{{ error }}
                        </div>
                        } } }
                    </div>
                </div>
                <div class="secondRow">
                    <div class="form-group">
                        <register-write-dropdowns
                            [class.drop-down__error]='(showValidationErrors() &&
                        academicInfoForm().get("course")?.errors?.[
                        "required" ] || backendErrors()["course"])'
                            [options]="courses"
                            [placeholder]="'register.courses.label' | translate"
                            valueField="id"
                            displayField="displayedName"
                            formControlName="course"
                        ></register-write-dropdowns>
                        @if ( showValidationErrors() &&
                        academicInfoForm().get("course")?.errors?.["required"] )
                        {
                        <div class="error">
                            <mat-icon svgIcon="errorQuadrilateral"></mat-icon
                            >You must select a course
                        </div>
                        } @if (backendErrors()["course"]) { @for ( error of
                        backendErrors()["course"]; track $index ) {
                        <div class="error">
                            <mat-icon svgIcon="errorQuadrilateral"></mat-icon
                            >{{ error }}
                        </div>
                        } }
                    </div>

                    <div class="form-group">
                        <register-write-dropdowns
                            [class.drop-down__error]='(showValidationErrors() &&
                        academicInfoForm().get("expertise")?.errors?.[
                        "required" ] || backendErrors()["expertise"])'
                            [options]="expertises"
                            [placeholder]="
                                'register.expertises.label' | translate
                            "
                            valueField="id"
                            displayField="displayedName"
                            formControlName="expertise"
                        ></register-write-dropdowns>
                        @if ( showValidationErrors() &&
                        academicInfoForm().get("expertise")?.errors?.[
                        "required" ] ) {
                        <div class="error">
                            <mat-icon svgIcon="errorQuadrilateral"></mat-icon
                            >You must select a expertise
                        </div>
                        } @if (backendErrors()["expertise"]) { @for ( error of
                        backendErrors()["expertise"]; track $index ) {
                        <div class="error">
                            <mat-icon svgIcon="errorQuadrilateral"></mat-icon
                            >{{ error }}
                        </div>
                        } }
                    </div>
                </div>
            </div>

            <button class="fill-button fill-red" type="submit">
                {{ "register.register" | translate }}
            </button>
            <div class="goBack">
                <a class="hyperlink" (click)="returnToPreviousStep()">
                    {{ "register.goBackLink" | translate }}
                </a>
            </div>
        </form>
        }
        <div class="language-selector-container">
            <div
                class="language-selector"
                [class.open]="isOpenLang()"
                role="region"
                aria-label="Language selection"
            >
                <button
                    class="selector-button"
                    (click)="toggleDropdownLang()"
                    aria-label="Select language"
                    [attr.aria-expanded]="isOpenLang()"
                    aria-controls="language-dropdown"
                >
                    @if(currentLanguage$ | async; as lang){
                    <div>
                        <img
                            [src]="lang.flagSquare"
                            [alt]="lang.name"
                            class="flag-icon"
                        />
                        <span>{{ lang.name }}</span>
                    </div>
                    <mat-icon
                        svgIcon="arrowDown"
                        class="chevron"
                        [class.up]="isOpenLang()"
                        alt="arrowDown"
                        aria-hidden="true"
                    ></mat-icon>
                    }
                </button>
                @if (isOpenLang()) {
                <div class="dropdown-menu">
                    @for (lang of languageSwitcher.supportedLanguages(); track
                    lang.code) { @if (lang.code !==
                    languageSwitcher.currentLang()) {
                    <button
                        class="language-option"
                        (click)="selectLanguage(lang.code)"
                        [attr.aria-label]="lang.name"
                    >
                        <img
                            [src]="lang.imgFullPath"
                            [alt]="lang.name"
                            class="flag-icon"
                        />
                        <span>{{ lang.name }}</span>
                    </button>
                    } }
                </div>
                }
            </div>
        </div>
    </div>
</main>
